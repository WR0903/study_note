## 内存火焰图使用
在linux上我们需要对开发的程序进行调优，主要的是分析cpu占用，可以使用top、htop、pstack相关指令，但是火焰图可以很方便的看到cpu消耗在哪里。
### 安装perf
```
root@master:~# apt install linux-tools-common linux-tools-4.4.0-142-generic linux-cloud-tools-4.4.0-142-generic -y

root@master:~# perf -v #显示perf的版本
perf version 4.4.167
```

### 采集调用栈信息
```
root@master:~# sudo perf record -F 99 -p 25633 -g -- sleep 30
```
这个指令的意思是对进程25633进行采样，每秒99次，一共采集30秒。
生成的数据在当前目录下，perf.data。

###  查看每个调用栈的百分比
```
root@master:~# sudo perf report -n --stdio
```
```
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 2  of event 'cpu-clock:pppH'
# Event count (approx.): 20202020
#
# Children      Self       Samples  Command       Shared Object       Symbol
# ........  ........  ............  ............  ..................  ..................................
#
   100.00%     0.00%             0  redis-server  [kernel.kallsyms]   [k] entry_SYSCALL_64_after_hwframe
            |
            ---entry_SYSCALL_64_after_hwframe
               do_syscall_64
               |
               |--50.00%--__x64_sys_read
               |          ksys_read
               |          vfs_read
               |          __vfs_read
               |          seq_read
               |          kvmalloc_node
               |          _cond_resched
               |
                --50.00%--__x64_sys_openat
                          do_sys_open
                          do_filp_open
                          path_openat
                          link_path_walk.part.0
                          walk_component
                          lookup_fast
                          legitimize_mnt
                          __legitimize_mnt

   100.00%     0.00%             0  redis-server  [kernel.kallsyms]   [k] do_syscall_64
            |
            ---do_syscall_64
               |
               |--50.00%--__x64_sys_read
               |          ksys_read
               |          vfs_read
               |          __vfs_read
               |          seq_read
               |          kvmalloc_node
               |          _cond_resched
               |
                --50.00%--__x64_sys_openat
                          do_sys_open
                          do_filp_open
                          path_openat
                          link_path_walk.part.0
                          walk_component
                          lookup_fast
                          legitimize_mnt
                          __legitimize_mnt

    50.00%    50.00%             1  redis-server  [kernel.kallsyms]   [k] _cond_resched
            |
:
```
虽然能看到每个调用栈的占用比，但是不是很直观
### 火焰图绘制
```
git clone https://github.com/brendangregg/FlameGraph.git
```
折叠堆栈信息
```
root@master:~# perf script -i /root/perf.data &> /root/perf.unfold
```
用 stackcollapse-perf.pl 将 perf 解析出的内容 perf.unfold 中的符号进行折叠
```
root@master:~/FlameGraph# ls
aix-perf.pl    docs                        example-perf.svg  pkgsplit-perf.pl  stackcollapse-aix.pl       stackcollapse-go.pl               stackcollapse-ljp.awk         stackcollapse-pmc.pl        stackcollapse-vsprof.pl   test.sh
demos          example-dtrace-stacks.txt   files.pl          range-perf.pl     stackcollapse-bpftrace.pl  stackcollapse-instruments.pl      stackcollapse-perf.pl         stackcollapse-recursive.pl  stackcollapse-vtune.pl
dev            example-dtrace.svg          flamegraph.pl     README.md         stackcollapse-elfutils.pl  stackcollapse-java-exceptions.pl  stackcollapse-perf-sched.awk  stackcollapse-sample.awk    stackcollapse-xdebug.php
difffolded.pl  example-perf-stacks.txt.gz  jmaps             record-test.sh    stackcollapse-gdb.pl       stackcollapse-jstack.pl           stackcollapse.pl              stackcollapse-stap.pl       test
root@master:~/FlameGraph# ./stackcollapse-perf.pl /root/perf.unfold &> /root/perf.folded
root@master:~/FlameGraph#
```
最后就是生成火焰?图了
```
root@master:~/FlameGraph# ./flamegraph.pl /root/perf.folded > /root/perf.svg
```
然后用谷歌浏览器打开就能看到该火焰图
![](https://github.com/WR0903/study_note/blob/master/perf.png)
